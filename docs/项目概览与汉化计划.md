# GM's Grimoire 项目总览与汉化展望

> 面向初学者的快速解读，帮助你在不熟悉 Owlbear Rodeo 生态的情况下，也能理解本插件的功能与代码结构，并规划后续汉化工作。

## 1. 插件能做什么
- **血量/护甲可视化**：为角色或怪物标记 HP、临时 HP、AC，并可在地图上显示条形/文字/盾牌，支持玩家可见性控制。
- **分组与排序**：按自定义分组管理 Token，支持拖拽排序、按先攻自动排序（升/降序）、“战斗模式”紧凑界面。
- **先攻与回合管理**：群体掷先攻、当前/下一个单位提示，结束回合消息广播。
- **Statblock 读取与同步**：从 Tabletop Almanac（5e、PF2e）搜索并绑定 statblock，自动填充 HP/AC/先攻加值/可用次数（limits），可重新同步。
- **玩家视角**：玩家窗口只展示被授权的 Token，支持分离的可见性与血量模糊段位（hpBarSegments）。
- **地图右键菜单**：快速把 Token 加入/移出插件、群体伤害/治疗、多选批量开关可见性。
- **骰子系统**：内置 dddice、Dice+ 或本地计算三种模式；提供掷骰日志、快捷骰、可自定义预设；广播结果或私掷。
- **休息与资源恢复**：短休/长休重置限制次数、恢复生命值；限制资源（法术位/充能）自动扣减。
- **迁移与兼容**：内置多版本迁移脚本，自动升级旧场景/房间元数据。

## 2. 运行形态（多页面扩展）
- `index.html` + `src/main.ts`：主 Action Window（GM/玩家用）。
- `popover.html` + `src/popover.ts`：场景右键弹出的小型控制面板/批量操作。
- `modal.html` + `src/modal.ts`：设置、帮助、更新日志、骰子登录等模态窗口。
- `statblock.html` + `src/statblock.ts`：Statblock 总览/多面板 Popover。
- `rolllog.html` + `src/rolllog.ts`：独立掷骰记录/设置面板。
- `background.html` + `src/background/init.ts`：后台脚本，负责上下文菜单注册、元数据初始化、消息总线与骰子集成。
- Vite 构建入口在 `vite.config.ts`，定义多页面与证书、拷贝 `_headers` 等。

## 3. 代码总览（按目录）
- `src/components/gmgrimoire/`：主界面组件（分组、Token 卡片、战斗回合、Statblock 子页等）。核心容器 `GMGrimoire.tsx` 负责布局、拖拽排序、玩家/GM 视图切换。
- `src/components/popover/`：右键弹出层 UI（单选/多选 Token 批量操作）。
- `src/components/modal/`：设置、帮助、日志、骰子登录、分组管理等模态子页。
- `src/components/statblock/`：Statblock Popover、多规则集（5e/PF2e）渲染、搜索与共享能力。
- `src/components/general/`：通用控件（按钮、下拉、Loader、Markdown 渲染、骰子托盘、上下文提示等）。
- `src/components/svgs/`：所有内联 SVG 图标与骰子面图形。
- `src/context/`：Zustand/React Context 状态（房间/场景元数据、玩家信息、Token 列表、Dice/日志状态、UI 设置、Statblock 状态、共享能力等）。
- `src/helper/`：与 OBR SDK 交互的核心工具函数  
  - `helpers.ts`：元数据读写、Token 初始化、排序/分组、statblock 匹配、限制资源更新。  
  - `hpHelpers.ts`、`acHelper.ts`：HP/AC 的地图附件（文本/条/盾牌）生成与可见性更新。  
  - `diceHelper.ts`：dddice/Dice+/本地计算封装与广播。  
  - 其他如 `tokenHelper.ts`（元数据更新）、`limitHelpers.ts`（限制公式）、`previewHelpers.tsx`（预览渲染）等。
- `src/background/`：后台初始化、dddice 与 Dice+ 集成、API 消息路由（hp/ac/tempHP/initiative/dice/ability-share）。
- `src/api/`：对 Tabletop Almanac、dddice、PF/5e 接口的轻量封装。
- `src/migrations/`：从旧版本元数据到最新版本的自动迁移脚本（v103~v350）。
- `src/_css/`：分层 SCSS（base 变量/排版/动画 + 各组件样式）。
- 其他：`public/`、`icons/` 放置静态资源与 SVG；`Makefile` 提供 `make build/run`；`docs/` 存放商店介绍与示例截图/GIF。

## 4. 核心数据与交互
- **元数据键**：  
  - 场景/房间：`metadataKey = com.bitperfect-software.hp-tracker/metadata` 存储全局设置（规则集、HP 条段数、偏移、骰子类型、分组、排序方式等）。  
  - Token：`itemMetadataKey = .../data` 存储每个 Token 的 HP/AC/先攻/规则集/分组/可见性/限制资源等。  
  - 地图附着物：`infoMetadataKey = .../text` 区分 HP 文本、HP 条、AC 盾牌。  
- **初始化流程**（见 `src/background/init.ts`）：  
  1) `initRoom`/`initScene` 设置默认房间与场景元数据。  
  2) `initItems` 为已激活的 Token 重建 HP/AC 附件并同步显示。  
  3) 注册右键菜单：加入/移除 GMG、道具/角色区分、结束回合按钮。  
  4) 监听 `OBR.broadcast` 消息（hp/tempHP/ac/init/dice/ability-share），实现跨窗口通信与玩家提示。  
  5) 运行迁移脚本确保版本兼容。  
- **UI 数据流**：各入口组件用 `ContextWrapper` 注入 OBR SDK 上下文，再由多个 Context（玩家、Token 列表、元数据、UI 设置、角色卡等）分发到子组件。拖拽（`@hello-pangea/dnd`）和弹出层（`@floating-ui/react`、`@tippyjs/react`）处理交互。
- **掷骰路径**：UI 通过广播通道触发 `diceRoute` → 根据房间设置选择 dddice/Dice+/本地计算 → 写入 `RollLogContext` 并回传结果。
- **Statblock 同步**：搜索接口由 `TTRPG_URL`（环境变量）提供；`updateTokenSheet`/`resyncToken` 根据规则集写回 Token 元数据并刷新地图展示。

## 5. 构建与运行
- Node ≥ 18，`yarn` 1.22。  
- 常用脚本：`yarn dev`（Vite 多页热更）、`yarn build`（`tsc` + `vite build`）、`yarn preview`。  
- 生成产物位于 `dist/`，包含多入口 HTML 与复制的 `_headers`。本地开发需 HTTPS（`vite-plugin-mkcert`）。  
- 部署时通过 manifest.json 暴露给 Owlbear Rodeo，插件 ID `com.bitperfect-software.hp-tracker`。

## 6. 汉化展望与建议
1) **文本清单**：主要可见文案集中在 `components/gmgrimoire/*`, `components/modal/Components/*`, `components/popover/*`, `components/statblock/*` 以及部分 helper 返回的通知字符串。建议 `rg "\".*\"" src/components src/helper` 快速扫出硬编码英文。  
2) **最小改动方案**：引入轻量字典对象（如 `src/i18n.ts`）+ 简单 `t('key')` 工具，避免大规模改造；默认语言 en，新增 zh-CN。  
3) **UI 适配**：  
   - 按钮/标签较多的区域（Token 卡片、弹出层、设置项）需留意中文长度，必要时增加 `max-width`/`white-space` 或换行。  
   - 地图附件文本（HP/AC）保持数字+图标，无需翻译。  
4) **文档与截图**：`docs/` 多为英文截图，后续可补中文注释版；`store.md` 的描述可增补中文段落但保持英文以兼容商店。  
5) **验证流程**：  
   - 本地启动 `yarn dev`，在 Owlbear Rodeo 开发模式加载本地 manifest，逐窗体检查。  
   - 重点测试：右键菜单、战斗模式、statblock 搜索/同步、骰子三种模式、玩家视角可见性。  
6) **提交建议**：按照仓库指南使用 Conventional Commits，如 `docs: 添加项目概览与汉化计划`，并在 `AGENTS.md` 记录变更与后续 TODO。

## 7. 快速入口索引（便于继续阅读代码）
- 后台/生命周期：`src/background/init.ts`
- 元数据与 Token 同步：`src/helper/helpers.ts`, `src/helper/hpHelpers.ts`, `src/helper/acHelper.ts`
- 主界面：`src/components/gmgrimoire/GMGrimoire.tsx`
- 弹出层：`src/components/popover/Popover.tsx`
- 设置/帮助：`src/components/modal/Components/*`
- Statblock 渲染：`src/components/statblock/*`
- 掷骰：`src/helper/diceHelper.ts`, `src/context/RollLogContext.tsx`, `src/background/api.ts`

> 如果需要把某个子模块完全汉化，可从上面的索引切入，配合 `rg` 搜索字符串快速定位。
